<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Reset Password ‚Ä¢ Easy Business</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: linear-gradient(120deg, #f6f7f9, #eef2ff);
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .card {
      width: 100%;
      max-width: 440px;
      background: white;
      padding: 28px;
      border-radius: 18px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.12);
    }

    h2 {
      text-align: center;
      margin-bottom: 8px;
      font-size: 22px;
    }

    p {
      text-align: center;
      margin: 0 0 18px;
      color: #555;
      font-size: 15px;
      line-height: 1.4;
    }

    select {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ddd;
      margin-bottom: 18px;
      font-size: 14px;
    }

    .field {
      position: relative;
      margin-top: 12px;
    }

    input {
      width: 100%;
      padding: 12px 42px 12px 12px;
      border-radius: 12px;
      border: 1px solid #ddd;
      font-size: 15px;
      box-sizing: border-box;
    }

    input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37,99,235,0.15);
    }

    .eye {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      font-size: 16px;
      color: #666;
    }

    .hint {
      font-size: 13px;
      margin-top: 6px;
      color: #666;
    }

    button {
      width: 100%;
      margin-top: 18px;
      padding: 14px;
      border: none;
      border-radius: 14px;
      background: #2563eb;
      color: white;
      font-size: 16px;
      cursor: pointer;
      font-weight: 600;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .error {
      margin-top: 14px;
      text-align: center;
      color: #dc2626;
      font-weight: 500;
    }

    .success {
      margin-top: 14px;
      text-align: center;
      color: #16a34a;
      font-weight: 600;
    }
  </style>
</head>

<body>
  <div class="card">
    <h2 id="title">–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è</h2>
    <p id="desc">
      –í—ã –∑–∞–ø—Ä–æ—Å–∏–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ Easy Business.<br>
      –ü—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –Ω–∏–∂–µ.
    </p>

    <!-- Language -->
    <select id="lang" onchange="setLang(this.value)">
      <option value="ru">–†—É—Å—Å–∫–∏–π</option>
      <option value="en">English</option>
      <option value="tr">T√ºrk√ße</option>
    </select>

    <!-- Password -->
    <div class="field">
      <input id="password" type="password" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" />
      <span class="eye" onclick="toggle('password')">üëÅ</span>
    </div>

    <div class="hint" id="hint">
      –ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤, –ª–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã –∏ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã.
    </div>

    <!-- Confirm -->
    <div class="field">
      <input id="confirm" type="password" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" />
      <span class="eye" onclick="toggle('confirm')">üëÅ</span>
    </div>

    <button id="btn" onclick="resetPassword()">
      –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
    </button>

    <div id="result"></div>
  </div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // üî• anon key safe for frontend
  const supabase = createClient(
    "https://peewlvlbbiywjfjoawew.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBlZXdsdmxiYml5d2pmam9hd2V3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyODY1ODIsImV4cCI6MjA3Mzg2MjU4Mn0.bP7xwohBa5JOLT4_cQYz-nhprr6m6a43NUt-HcPCq8c"
  );

  const token = new URLSearchParams(window.location.search).get("token");
  const result = document.getElementById("result");
  const btn = document.getElementById("btn");

  // Language texts
  const texts = {
    ru: {
      title: "–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è",
      desc: "–í—ã –∑–∞–ø—Ä–æ—Å–∏–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ Easy Business.<br>–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –Ω–∏–∂–µ.",
      hint: "–ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤, –ª–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã –∏ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã.",
      save: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å",
      success: "–ü–∞—Ä–æ–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.",
      mismatch: "–ü–∞—Ä–æ–ª–∏ –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å",
      weak: "–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º —Å–ª–∞–±—ã–π",
    },
    en: {
      title: "Reset Password",
      desc: "You requested password recovery for Easy Business.<br>Please create a new password below.",
      hint: "Minimum 8 characters, latin letters, numbers and symbols.",
      save: "Save password",
      success: "Password updated! You can now log in.",
      mismatch: "Passwords do not match",
      weak: "Password is too weak",
    },
    tr: {
      title: "≈ûifre Sƒ±fƒ±rlama",
      desc: "Easy Business hesabƒ±nƒ±z i√ßin ≈üifre sƒ±fƒ±rlama istediniz.<br>L√ºtfen yeni bir ≈üifre olu≈üturun.",
      hint: "En az 8 karakter, latin harfleri, rakam ve sembol.",
      save: "≈ûifreyi Kaydet",
      success: "≈ûifre g√ºncellendi! Artƒ±k giri≈ü yapabilirsiniz.",
      mismatch: "≈ûifreler e≈üle≈ümiyor",
      weak: "≈ûifre √ßok zayƒ±f",
    }
  };

  let currentLang = "ru";

  window.setLang = (lang) => {
    currentLang = lang;
    document.getElementById("title").innerHTML = texts[lang].title;
    document.getElementById("desc").innerHTML = texts[lang].desc;
    document.getElementById("hint").innerHTML = texts[lang].hint;
    btn.innerHTML = texts[lang].save;
  };

  window.toggle = (id) => {
    const el = document.getElementById(id);
    el.type = el.type === "password" ? "text" : "password";
  };

  function validatePassword(pw) {
    const regex = /^[A-Za-z0-9!@#$%^&*()_\-+=<>?{}[\]|.,:;]+$/;
    return pw.length >= 8 && regex.test(pw);
  }

  window.resetPassword = async () => {
    const password = document.getElementById("password").value.trim();
    const confirm = document.getElementById("confirm").value.trim();

    result.innerHTML = "";

    if (!validatePassword(password)) {
      result.innerHTML = `<div class="error">${texts[currentLang].weak}</div>`;
      return;
    }

    if (password !== confirm) {
      result.innerHTML = `<div class="error">${texts[currentLang].mismatch}</div>`;
      return;
    }

    btn.disabled = true;

    const { data, error } = await supabase.functions.invoke(
      "reset_password",
      {
        body: { token, password },
      }
    );

    if (error) {
      result.innerHTML = `<div class="error">${error.message}</div>`;
      btn.disabled = false;
      return;
    }

    result.innerHTML = `<div class="success">${texts[currentLang].success}</div>`;
    btn.style.display = "none";
  };
</script>

</body>
</html>
